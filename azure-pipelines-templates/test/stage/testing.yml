parameters:
- name: SolutionBaseName
  type: string

stages:
- stage: Test
  dependsOn: Build
  displayName: Run Tests on Ephemeral SQL DB
  variables:
  - group: AT DevTest Shared Resources
  - group: DevTest Management Resources
  - name: ephemeralSQLDBName
    value: db_ci_tests-$(Build.BuildId)
  jobs:
  - deployment: DeploySQLDB
    displayName: Deploy Ephemeral SQL DB using Dacpac
    pool:
      name: DAS - Continuous Deployment Agents
    environment: AT
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzurePowerShell@5
            displayName: 'Fetch SQL Server Admin password from key vault'
            inputs:
              azureSubscription: $(ARMServiceConnection)
              scriptType: inlineScript
              inline: |
                $SharedSqlServerAdminPassword = Get-AzKeyVaultSecret -VaultName $(SharedKeyVaultName) -Name $(SharedSQLServerName) -AsPlainText
                Write-Output "Setting variable SharedSqlServerAdminPassword"
                Write-Output "##vso[task.setvariable variable=SharedSqlServerAdminPassword;isreadonly=true;issecret=true]$SharedSqlServerAdminPassword"
              azurePowerShellVersion: LatestVersion
          - task: SqlAzureDacpacDeployment@1
            condition: and(succeeded(), ne(variables.SetBlockOnPossibleDataLossArgument, true))
            displayName: Execute Azure SQL DacpacTask without AdditionalArguments
            inputs:
              AzureSubscription: $(ARMServiceConnection)
              DacpacFile: $(Pipeline.Workspace)/DacpacArtifact/src/${{ parameters.SolutionBaseName }}.Database/bin/release/netstandard2.1/${{ parameters.SolutionBaseName }}.Database.dacpac
              DatabaseName: $(ephemeralSQLDBName)
              ServerName: $(SharedSQLServerFQDN)
              SqlPassword: $(SharedSqlServerAdminPassword)
              SqlUsername: $(SharedSQLServerUsername)

  - job: RunTests
    pool:
      vmImage: ubuntu-latest
    displayName: Run Tests
    dependsOn: DeploySQLDB
    variables:
      SharedSqlServerAdminPassword: $[ dependencies.DeploySQLDB.outputs['fetchSQLServerPassword.SharedSqlServerAdminPassword'] ]
    steps:
    - checkout: das-platform-automation
    - download: current
      artifact: ${{ parameters.SolutionBaseName }}

    - powershell: |
        Write-Host "##vso[task.setvariable variable=ADO_CONNSTR;issecret=true]Server=tcp:$(SharedSQLServerName),1433;Initial Catalog=$(ephemeralSQLDBName);Persist Security Info=False;User ID=$(SharedSQLServerUsername);Password=$(SharedSqlServerAdminPassword);MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;"
      displayName: Set Connection String Variable

    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '8.x'

    # Unit tests
    # - powershell: |
    #     dotnet test --configuration 'Release' --filter 'TestCategory!=Integration'
    #   displayName: Run Unit Tests
    #   workingDirectory: $(Pipeline.Workspace)/${{ parameters.SolutionBaseName }}/src

    # Integration tests (point SQL DB)
    # - powershell: |
    #     $env:ConnectionStrings__Integration = '$(ADO_CONNSTR)'
    #     $env:IntegrationTestsDbSchemaName = '$(ephemeralSQLDBName)'
    #     dotnet test --configuration 'Release' --filter 'TestCategory=Integration'
    #   displayName: Run Integration Tests
    #   workingDirectory: $(Pipeline.Workspace)/${{ parameters.SolutionBaseName }}/src

    # Cleanup (best-effort)
    - task: AzurePowerShell@5
      displayName: Tear down SQL DB
      condition: always()
      inputs:
        azurePowerShellVersion: LatestVersion
        azureSubscription: SFA-DAS-DevTest-ARM
        ScriptType: inlineScript
        Inline: |
          Remove-AzSqlDatabase -DatabaseName '$(ephemeralSQLDBName)' -ResourceGroupName '$(SharedEnvResourceGroup)' -ServerName '$(SharedSQLServerFQDN)' -Force
    # - task: AzureCLI@2
    #   displayName: Tear down SQL DB
    #   condition: always()
    #   inputs:
    #     azureSubscription: SFA-DAS-DevTest-ARM
    #     scriptType: bash 
    #     scriptLocation: inlineScript
    #     inlineScript: |
    #       az sql db delete --name '$(ephemeralSQLDBName)' --resource-group '$(SharedEnvResourceGroup)' --server '$(SharedSQLServerFQDN)' --yes
          
    #       az sql db delete --name 'db_ci_tests-1032424' --resource-group 'das-at-shared-rg' --server 'das-at-shared-sql' --yes
