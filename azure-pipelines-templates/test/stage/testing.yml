parameters:
- name: ArtifactName
  type: string
- name: SolutionBaseName
  type: string

stages:
- stage: Test
  dependsOn: Build
  displayName: Run Tests on Ephemeral SQL DB
  variables:
  - group: AT DevTest Shared Resources
  - group: DevTest Management Resources
  - name: ephemeralSQLDBName
    value: db_ci_tests-$(Build.BuildId)
  jobs:
  - deployment: DeploySQLDB
    displayName: Deploy Ephemeral SQL DB using Dacpac
    pool:
      name: DAS - Continuous Deployment Agents
    environment: AT
    strategy:
      runOnce:
        deploy:
          steps:
          - template: ../../deploy/step/sql-dacpac-deploy.yml
            parameters:
              AzureSubscription: $(ARMServiceConnection)
              DacpacFile: $(Pipeline.Workspace)/DacpacArtifact/src/${{ parameters.SolutionBaseName }}.Database/bin/release/netstandard2.1/${{ parameters.SolutionBaseName }}.Database.dacpac
              DatabaseName: $(ephemeralSQLDBName)
              Environment: AT
              OverrideBlockOnPossibleDataLoss: false
              ServerName: $(SharedSQLServerFQDN)
              SqlUsername: $(SharedSQLServerUsername)

  - template: ../job/run-tests.yml
    parameters:
      ArtifactName: ${{ parameters.ArtifactName }}
