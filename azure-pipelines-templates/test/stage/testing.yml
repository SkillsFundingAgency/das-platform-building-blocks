parameters:
- name: SolutionBaseName
  type: string

stages:
- stage: Test
  dependsOn: Build
  displayName: Run Tests on Ephemeral SQL DB
  variables:
  - group: AT DevTest Shared Resources
  - group: DevTest Management Resources
  - name: ephemeralSQLDBName
    value: db_ci_tests-$(Build.BuildId)
  jobs:
  - deployment: DeploySQLDB
    displayName: Deploy Ephemeral SQL DB using Dacpac
    pool:
      name: DAS - Continuous Deployment Agents
    environment: AT
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzurePowerShell@5
            displayName: 'Fetch SQL Server Admin password from key vault'
            inputs:
              azureSubscription: $(ARMServiceConnection)
              scriptType: inlineScript
              inline: |
                $SharedSQLServerPassword = Get-AzKeyVaultSecret -VaultName $(SharedKeyVaultName) -Name $(SharedSQLServerName) -AsPlainText
                Write-Output "Setting variable SharedSQLServerPassword"
                Write-Output "##vso[task.setvariable variable=SharedSQLServerPassword;isreadonly=true;issecret=true]$SharedSQLServerPassword"
              azurePowerShellVersion: LatestVersion
          - task: SqlAzureDacpacDeployment@1
            condition: and(succeeded(), ne(variables.SetBlockOnPossibleDataLossArgument, true))
            displayName: Execute Azure SQL DacpacTask without AdditionalArguments
            inputs:
              AzureSubscription: $(ARMServiceConnection)
              DacpacFile: $(Pipeline.Workspace)/DacpacArtifact/src/${{ parameters.SolutionBaseName }}.Database/bin/release/netstandard2.1/${{ parameters.SolutionBaseName }}.Database.dacpac
              DatabaseName: $(ephemeralSQLDBName)
              ServerName: $(SharedSQLServerFQDN)
              SqlPassword: $(SharedSQLServerPassword)
              SqlUsername: $(SharedSQLServerUsername)

  - job: RunTests
    pool:
      name: DAS - Continuous Deployment Agents
    displayName: Run Tests
    dependsOn: DeploySQLDB
    variables:
      SharedSQLServerPassword: $[ dependencies.DeploySQLDB.outputs['fetchSQLServerPassword.SharedSQLServerPassword'] ]
    steps:
    - checkout: das-platform-automation
    - download: current
      artifact: ${{ parameters.SolutionBaseName }}

    - powershell: |
        Write-Host "##vso[task.setvariable variable=ADO_CONNSTR;issecret=true]Server=tcp:$(SharedSQLServerName),1433;Initial Catalog=$(ephemeralSQLDBName);Persist Security Info=False;User ID=$(SharedSQLServerUsername);Password=$(SharedSQLServerPassword);MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;"
      displayName: Set Connection String Variable

    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '8.x'

    # Unit tests
    - powershell: |
        dotnet test --configuration 'Release' --filter 'TestCategory!=Integration'
      displayName: Run Unit Tests
      workingDirectory: $(Pipeline.Workspace)/${{ parameters.SolutionBaseName }}/src

    # Integration tests (point SQL DB)
    - powershell: |
        $env:ConnectionStrings__Integration = '$(ADO_CONNSTR)'
        $env:IntegrationTestsDbSchemaName = '$(ephemeralSQLDBName)'
        dotnet test --configuration 'Release' --filter 'TestCategory=Integration'
      displayName: Run Integration Tests
      workingDirectory: $(Pipeline.Workspace)/${{ parameters.SolutionBaseName }}/src

    # Cleanup (best-effort)
    - task: AzurePowerShell@5
      displayName: Tear down SQL DB
      condition: always()
      inputs:
        azurePowerShellVersion: LatestVersion
        azureSubscription: SFA-DAS-DevTest-ARM
        ScriptType: inlineScript
        Inline: |
          Remove-AzSqlDatabase -DatabaseName '$(ephemeralSQLDBName)' -ResourceGroupName '$(SharedEnvResourceGroup)' -ServerName '$(SharedSQLServerName)' -Force
