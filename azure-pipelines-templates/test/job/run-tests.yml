parameters:
- name: ArtifactName
  type: string
  
jobs:
- job: RunTests
  pool:
    vmImage: ubuntu-latest
  displayName: Run Tests
  dependsOn: DeploySQLDB
  variables:
    SharedSqlServerAdminPassword: $[ dependencies.DeploySQLDB.outputs['fetchSQLServerPassword.SharedSqlServerAdminPassword'] ]
  steps:
  - checkout: das-platform-automation
  - download: current
    artifact: ${{ parameters.ArtifactName }}

  - powershell: |
      Write-Host "##vso[task.setvariable variable=ADO_CONNSTR;issecret=true]Server=tcp:$(SharedSQLServerName),1433;Initial Catalog=$(ephemeralSQLDBName);Persist Security Info=False;User ID=$(SharedSQLServerUsername);Password=$(SharedSQLServerPassword);MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;"
    displayName: Set Connection String Variable

  - task: UseDotNet@2
    inputs:
      packageType: 'sdk'
      version: '8.x'

  # Unit tests
  - powershell: |
      dotnet test --configuration 'Release' --filter 'TestCategory!=Integration'
    displayName: Run Unit Tests
    workingDirectory: $(Pipeline.Workspace)/${{ parameters.ArtifactName }}/src

  # Integration tests (point SQL DB)
  - powershell: |
      $env:ConnectionStrings__Integration = '$(ADO_CONNSTR)'
      $env:IntegrationTestsDbSchemaName = '$(ephemeralSQLDBName)'
      dotnet test --configuration 'Release' --filter 'TestCategory=Integration'
    displayName: Run Integration Tests
    workingDirectory: $(Pipeline.Workspace)/${{ parameters.ArtifactName }}/src

  # Cleanup (best-effort)
  - task: AzurePowerShell@5
    displayName: Tear down SQL DB
    condition: always()
    inputs:
      azurePowerShellVersion: LatestVersion
      azureSubscription: $(ARMServiceConnection)
      ScriptType: inlineScript
      Inline: |
        Remove-AzSqlDatabase -DatabaseName '$(ephemeralSQLDBName)' -ResourceGroupName '$(SharedEnvResourceGroup)' -ServerName '$(SharedSQLServerFQDN)' -Force
